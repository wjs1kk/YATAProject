<?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.yata.mapper.CarMapper">
	
<!-- 	예약하기 페이지 출고가능한 차만 출력 -->
	<select id="selectCars" resultType="com.itwillbs.yata.vo.CarVO">
		select * from car where car_available = 1
	</select>
<!-- 	예약확인 페이지 차량 상세정보 -->
	<select id="selectCar" resultType="com.itwillbs.yata.vo.CarVO">
		select * 
			from car 
			where car_id = #{car_id} 
	</select>
<!-- 	차량 검색 출고가능한 차만 출력 -->
	<select id="searchByName" parameterType="String" resultType="com.itwillbs.yata.vo.CarVO">
  	 	SELECT * 
  	 		FROM car 
  	 		WHERE car_name LIKE CONCAT('%',#{car_name},'%') and car_available = 1 
  	</select>
  	<!--   	car_type 카테고리 -->
  	<select id="car_type" parameterType="String" resultType="com.itwillbs.yata.vo.CarVO">
  	 	SELECT *
  	 		FROM car 
  	 			WHERE car_available = 1 and car_type  LIKE 
	  	 		<choose>
	  	 			<when test="car_type.equals('전체')"> '%' </when>
	  	 			<when test="car_type.equals('전기')"> '전기' </when>
	  	 			<when test="car_type.equals('경형')"> '경형' </when>
	  	 			<when test="car_type.equals('중형')"> '중형' </when>
	  	 			<when test="car_type.equals('대형')"> '대형' </when>
	  	 			<when test="car_type.equals('SUV')"> 'SUV' </when>
  	 			</choose> 	                                                                                                                                                                                                                                                                           
  	</select>
  	
<!--   	=========================================관리자================================== -->
  	<select id="selectCarList" resultType="com.itwillbs.yata.vo.CarVO">
		select *
		from car
		<if test="!searchType.equals('')">
			WHERE
			<choose>
				<when test="searchType.equals('car_manufacturer')">
					car_manufacturer LIKE CONCAT('%', #{searchKeyword}, '%') 
				</when>
				<when test="searchType.equals('car_name')">
					car_name LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType.equals('car_fuel')">
					car_fuel LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType.equals('car_available')">
					car_available LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
			</choose>
		</if>
		ORDER BY car_id DESC
		LIMIT #{startRow}, #{listLimit}
	</select>
  	<select id="selectCarListCount" resultType="int">
		SELECT COUNT(car_id)
		FROM car
		<if test="!searchType.equals('')">
			WHERE
			<choose>
				<when test="searchType.equals('car_manufacturer')">
					car_manufacturer LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType.equals('car_name')">
					car_name LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType.equals('car_fuel')">
					car_fuel LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType.equals('car_available')">
					car_available LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
			</choose>
		</if>
	</select>
	<update id="carUpdate">
		UPDATE car
		SET car_manufacturer = #{car_manufacturer}
			<if test="car_model != null and !car_model.equals('')">
  			   , car_model = #{car_model}
  			</if>
  			   , car_name = #{car_name}
  			   , car_type = #{car_type}
  			   , car_year = #{car_year}
  			   , car_price = #{car_price}  			
  			   , car_seater = #{car_seater}
  			   , car_fuel = #{car_fuel}
  		WHERE car_id = #{car_id}
	</update>
	
	<delete id="deleteCar">
		DELETE
		FROM car
		WHERE car_id = #{car_id}
	</delete>
  	<insert id="adminCarRegist">
  	
  		<selectKey keyProperty="car_id" resultType="int" order="BEFORE">
			SELECT IFNULL(MAX(car_id), 0) FROM car
		</selectKey>
		
  		INSERT INTO car
  		VALUES(#{car_id} + 1
  			   , #{car_manufacturer}
  			   , #{car_model}
  			   , #{car_name}
  			   , #{car_type}
  			   , #{car_year}
  			   , #{car_price}
  			   , '1'
  			   , #{car_seater}
  			   , #{car_fuel}
  			  )
  	</insert>
  	
  	<!-- 2023-04-27 김동욱 - 출고된 차량 리스트  페이징 처리 및 reservation과 JOIN해야 렌트중인 member_email까지 출력 -->
  	<!-- 2023-04-28 김동욱 - 출고된 차량 리스트 : 예약 테이블과 JOIN하면 전에 빌렸던 차량도 같이 나와서 수정-->
  	<select id="selectCarShippedList" resultType="map">
  		SELECT car_id, car_manufacturer, car_model, car_name, car_type, car_year, car_price, car_available, car_seater, car_fuel
			FROM car
		    WHERE car_available = '0'
  		<if test="!searchType.equals('')">
  			AND
			<choose>
  	<!-- 2023-04-28 김동욱 - member_email에서 car_id로 변경-->
				<when test="searchType.equals('car_id')">
				 	 car_id LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType.equals('car_name')">
					 car_name LIKE CONCAT('%', #{searchKeyword},'%')
				</when>
				<when test="searchType.equals('car_manufacturer')">
					 car_manufacturer LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
			</choose>
		</if>
		LIMIT #{startRow}, #{listLimit}
  	</select>
  	<!-- 2023-04-27 김동욱 - 출고된 차량 리스트 페이징 처리를 위한 카운트 -->
  	<!-- 2023-04-28 김동욱 - 출고된 차량 리스트 : 예약 테이블과 JOIN하면 전에 빌렸던 차량도 같이 나와서 수정-->
  	<select id="selectCarShippedListCount" resultType="int">
  		select COUNT(*)
		FROM car
	    WHERE car_available = '0'
	    <if test="!searchType.equals('')">
	   		 AND
			<choose>
		  	<!-- 2023-04-28 김동욱 - member_email에서 car_id로 변경-->
				<when test="searchType.equals('car_id')">
				 	car_id LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType.equals('car_name')">
					car_name LIKE CONCAT('%', #{searchKeyword},'%')
				</when>
				<when test="searchType.equals('car_manufacturer')">
					car_manufacturer LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
			</choose>
		</if>
  	</select>
  	
  	<update id="deleteCarModel">
  		UPDATE car SET car_model = ""
  		WHERE car_id = #{car_id}
  	</update>
	<update id="updateCarReturnCheck">
  		UPDATE car SET car_available = "1"
  		WHERE car_id = #{car_id}
  	</update>
</mapper>